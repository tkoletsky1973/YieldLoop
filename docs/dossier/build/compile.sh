#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"
MANIFEST="$ROOT/docs/dossier/build/manifest.txt"
OUT_MD="$ROOT/docs/dossier/build/YieldLoop_Canonical_Dossier.md"

echo "# YieldLoop â€” Canonical Project Dossier" > "$OUT_MD"
echo "" >> "$OUT_MD"
echo "_Auto-compiled from repository sources. Do not edit this file directly._" >> "$OUT_MD"
echo "" >> "$OUT_MD"
echo "---" >> "$OUT_MD"
echo "" >> "$OUT_MD"

while IFS= read -r FILE; do
  [[ -z "$FILE" ]] && continue
  [[ "$FILE" =~ ^# ]] && continue

  PATHF="$ROOT/$FILE"
  if [[ ! -f "$PATHF" ]]; then
    echo "Missing file: $FILE" >&2
    exit 1
  fi

  echo "" >> "$OUT_MD"
  echo "---" >> "$OUT_MD"
  echo "" >> "$OUT_MD"
  echo "## Source: \`$FILE\`" >> "$OUT_MD"
  echo "" >> "$OUT_MD"
  cat "$PATHF" >> "$OUT_MD"
  echo "" >> "$OUT_MD"
done < "$MANIFEST"

echo "Compiled -> $OUT_MD"
